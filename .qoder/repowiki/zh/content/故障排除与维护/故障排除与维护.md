# 故障排除与维护

<cite>
**本文档引用的文件**  
- [init.lua](file://init.lua)
- [lazy.lua](file://lua/config/lazy.lua)
- [lsp-config.lua](file://lua/plugins/lsp-config.lua)
- [mason.lua](file://lua/plugins/mason.lua)
- [test_optimizations.lua](file://test_optimizations.lua)
</cite>

## 目录
1. [简介](#简介)
2. [常见问题与解决方案](#常见问题与解决方案)
3. [日志与状态检查](#日志与状态检查)
4. [配置重置与恢复](#配置重置与恢复)
5. [定期维护建议](#定期维护建议)
6. [附录](#附录)

## 简介
本文档旨在为 Neovim 用户提供全面的故障排除与维护指南，涵盖插件管理、LSP 服务器、键位响应、性能优化等核心问题。基于当前配置结构，提供可操作的解决方案和最佳实践。

## 常见问题与解决方案

### 插件无法安装
**问题描述**：使用 `:Lazy install` 安装插件失败，可能与网络或 lazy.nvim 状态有关。

**排查步骤**：
1. 检查网络连接是否正常。
2. 确认 `lazy.nvim` 是否正确安装在 `~/.local/share/nvim/lazy/lazy.nvim`。
3. 查看 `:Lazy` 界面中的错误日志。
4. 手动克隆 lazy.nvim：
   ```bash
   git clone https://github.com/folke/lazy.nvim.git ~/.local/share/nvim/lazy/lazy.nvim
   ```

**解决方案**：
- 确保 Git 可用且网络通畅。
- 检查 `lua/config/lazy.lua` 中的克隆逻辑是否执行成功。

**Section sources**
- [lazy.lua](file://lua/config/lazy.lua#L1-L20)

### LSP 服务器启动失败
**问题描述**：语言服务器（如 `pyright`、`lua_ls`）无法启动，影响代码补全与诊断。

**排查步骤**：
1. 检查 Mason 是否已安装对应 LSP：
   ```vim
   :Mason
   ```
2. 确认 `mason.nvim` 配置中 `ensure_installed` 是否包含目标服务器。
3. 检查路径配置是否正确，Mason 默认安装路径为 `~/.local/share/nvim/mason`。

**解决方案**：
- 通过 `:MasonInstall <server>` 手动安装。
- 确保 `mason.lua` 和 `lsp-config.lua` 配置一致，避免冲突。

**Section sources**
- [mason.lua](file://lua/plugins/mason.lua#L1-L50)
- [lsp-config.lua](file://lua/plugins/lsp-config.lua#L1-L30)

### 键位无响应
**问题描述**：自定义键位（如 `<leader>` 组合键）无响应或冲突。

**排查步骤**：
1. 检查 `which-key.nvim` 是否加载成功：
   ```vim
   :Lazy status
   ```
2. 确认 `keybindings.lua` 中的映射是否正确。
3. 检查是否存在键位冲突（如与终端或操作系统快捷键冲突）。

**解决方案**：
- 重启 Neovim 并运行 `:WhichKey` 查看键位映射。
- 检查 `lua/config/keybindings.lua` 是否被正确加载。

**Section sources**
- [init.lua](file://init.lua#L15-L20)
- [keybindings.lua](file://lua/config/keybindings.lua)

### 启动缓慢
**问题描述**：Neovim 启动时间过长，影响使用体验。

**排查步骤**：
1. 运行性能分析脚本：
   ```vim
   :lua require('test_optimizations').run()
   ```
2. 查看耗时最长的插件或配置项。

**解决方案**：
- 优化 `lazy.lua` 中的 `event` 触发时机，延迟加载非必要插件。
- 禁用不必要的 RTP 插件（已在配置中处理）。

**Section sources**
- [test_optimizations.lua](file://test_optimizations.lua)
- [lazy.lua](file://lua/config/lazy.lua#L50-L60)

## 日志与状态检查

### 查看 Neovim 日志
Neovim 的日志通常输出到标准错误流。可通过以下方式查看：
```vim
:messages
```
或启动时重定向日志：
```bash
nvim --headless -c 'qa!' 2> nvim.log
```

### 检查插件状态
使用 Lazy 内置命令查看插件状态：
```vim
:Lazy status
```
可查看插件是否加载、是否有错误、是否延迟加载。

**Section sources**
- [lazy.lua](file://lua/config/lazy.lua)

## 配置重置与恢复

### 重置配置
若配置异常，可按以下步骤重置：
1. 备份当前配置：
   ```bash
   mv ~/.config/nvim ~/.config/nvim.bak
   ```
2. 重新克隆配置仓库或恢复备份。

### 恢复默认设置
在 `init.lua` 中注释自定义配置，逐步排查问题：
```lua
-- require("config.lazy")
-- require("config.keybindings")
```

**Section sources**
- [init.lua](file://init.lua#L1-L10)

## 定期维护建议

### 插件更新策略
- 启用自动检查更新：
  ```lua
  checker = { enabled = true }
  ```
- 定期运行 `:Lazy sync` 更新插件。
- 使用 `:MasonUpdate` 更新 LSP 和工具链。

### 配置备份方法
- 使用 Git 管理配置：
  ```bash
  cd ~/.config/nvim
  git init
  git add .
  git commit -m "backup config"
  ```
- 定期推送到远程仓库。

### 性能监控技巧
- 使用 `test_optimizations.lua` 定期分析启动性能。
- 监控插件加载时间，优化 `event` 配置。
- 减少启动时同步操作，优先使用异步加载。

**Section sources**
- [test_optimizations.lua](file://test_optimizations.lua)
- [lazy.lua](file://lua/config/lazy.lua#L40-L50)

## 附录

### 相关命令速查
| 命令 | 说明 |
|------|------|
| `:Lazy status` | 查看插件状态 |
| `:Mason` | 打开 Mason 包管理器 |
| `:MasonInstall <pkg>` | 安装工具包 |
| `:Lazy sync` | 同步并更新所有插件 |
| `:WhichKey` | 查看键位映射 |

**Section sources**
- [lazy.lua](file://lua/config/lazy.lua)
- [mason.lua](file://lua/plugins/mason.lua)
- [lsp-config.lua](file://lua/plugins/lsp-config.lua)