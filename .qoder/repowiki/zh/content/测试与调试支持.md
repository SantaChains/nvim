# 测试与调试支持

<cite>
**本文档引用的文件**
- [essential.lua](file://lua/plugins/essential.lua)
- [test_optimizations.lua](file://test_optimizations.lua)
- [test_format.py](file://test_format.py)
- [mason.lua](file://lua/plugins/mason.lua)
</cite>

## 目录
1. [Neotest插件集成](#neotest插件集成)
2. [DAP调试支持状态](#dap调试支持状态)
3. [性能测试实现分析](#性能测试实现分析)
4. [格式化验证作用](#格式化验证作用)
5. [测试框架配置指导](#测试框架配置指导)
6. [使用技巧](#使用技巧)

## Neotest插件集成

Neotest插件在`essential.lua`中被集成，提供了完整的测试运行支持。通过配置`nvim-neotest/neotest`插件及其依赖项，实现了对多种测试框架的支持。

测试运行快捷键配置如下：
- `<leader>tn`：运行最近的测试
- `<leader>tf`：运行当前文件的所有测试
- `<leader>ts`：停止测试运行
- `<leader>to`：打开测试输出窗口
- `<leader>tp`：切换测试摘要面板

Neotest的状态显示、输出窗口和摘要面板均已启用，并配置了虚拟文本显示和符号标记，便于在编辑器中直观查看测试状态。

**Section sources**
- [essential.lua](file://lua/plugins/essential.lua#L309-L355)

## DAP调试支持状态

当前配置通过Mason插件管理器预留了对Debug Adapter Protocol（DAP）的支持。在`mason.lua`中，已配置安装多种语言的调试适配器：

- `debugpy`：Python调试支持
- `codelldb`：C/C++/Rust调试支持
- `js-debug-adapter`：JavaScript/TypeScript调试支持

这些调试适配器已集成到环境中，为相应语言提供了调试能力。虽然Go语言的`delve`调试器被注释禁用，但其他主流语言的调试支持均已准备就绪。

**Section sources**
- [mason.lua](file://lua/plugins/mason.lua#L50-L78)

## 性能测试实现分析

`test_optimizations.lua`文件实现了对Neovim配置优化的全面测试框架。该测试脚本通过一系列检查验证配置的正确性和性能优化效果。

主要测试功能包括：
- 插件冲突解决模块加载测试
- 优化初始化模块加载测试
- 用户命令注册状态测试
- 关键键位映射存在性测试
- 基础选项设置正确性测试
- 插件管理器及关键插件可用性测试

测试结果以可视化方式输出，使用表情符号标识通过（✅）和失败（❌）的测试项，并在最后提供统计摘要。脚本还实现了`run_all_tests()`和`quick_check()`两个主要函数，分别用于完整测试和快速检查。

此外，脚本创建了两个用户命令：
- `TestOptimizations`：运行完整的优化配置测试
- `QuickCheck`：快速检查关键配置状态

**Section sources**
- [test_optimizations.lua](file://test_optimizations.lua#L124-L223)

## 格式化验证作用

`test_format.py`文件作为格式化验证的示例文件，展示了代码格式化前后的对比。该文件包含不规范的代码格式，如缺少空格的运算符和多余的空白，可用于测试代码格式化工具的效果。

通过对比格式化前后的代码，可以验证格式化工具是否正确处理了以下情况：
- 运算符周围的空格（如`x=1+2`应格式化为`x = 1 + 2`）
- 变量赋值中的多余空白（如`y     =     3+4`）
- 函数返回语句的格式

此文件可作为测试用例，验证Python代码格式化工具（如black、autopep8等）是否按预期工作。

**Section sources**
- [test_format.py](file://test_format.py#L0-L3)

## 测试框架配置指导

为配置Python测试框架，建议采取以下步骤：

1. **安装测试框架**：
   - 对于pytest：`pip install pytest`
   - 对于unittest：Python标准库自带，无需额外安装

2. **配置Neotest适配器**：
   在`essential.lua`中取消注释并配置相应的适配器：
   ```lua
   adapters = {
     require('neotest-python')({
       python = "python",
       -- 可配置pytest或unittest
       dap = { justMyCode = false }
     })
   }
   ```

3. **创建测试文件**：
   确保测试文件命名符合框架要求（如`test_*.py`或`*_test.py`）

4. **运行测试**：
   使用`<leader>tn`运行最近的测试，或`<leader>tf`运行整个文件的测试

5. **调试测试**：
   结合已安装的`debugpy`，可通过DAP配置进行测试调试

**Section sources**
- [essential.lua](file://lua/plugins/essential.lua#L309-L355)
- [mason.lua](file://lua/plugins/mason.lua#L50-L78)

## 使用技巧

### 测试结果可视化
- 使用`<leader>tp`打开测试摘要面板，查看所有测试的层次结构
- 失败的测试会在代码旁边显示错误符号和虚拟文本
- 通过摘要面板的`e`键展开错误详情，`o`键查看完整输出

### 失败诊断
- 运行`:TestOptimizations`执行完整的配置健康检查
- 使用`:QuickCheck`快速验证关键功能是否正常
- 检查Mason安装的工具是否完整，确保所有依赖都已正确安装
- 查看Neotest输出窗口中的详细错误信息，定位问题根源

### 性能优化验证
- 定期运行`test_optimizations.lua`中的测试，确保优化配置持续有效
- 关注插件冲突解决、键位映射和基础选项设置的测试结果
- 当配置更改后，立即运行测试以验证没有引入回归问题

**Section sources**
- [test_optimizations.lua](file://test_optimizations.lua#L124-L223)
- [essential.lua](file://lua/plugins/essential.lua#L309-L355)